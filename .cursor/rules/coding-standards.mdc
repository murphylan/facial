---
description: å¼€å‘è§„èŒƒ - Server Actionsã€React Query Hooksã€çŠ¶æ€ç®¡ç†
globs:
  - "src/app/actions/**/*"
  - "src/hooks/**/*"
  - "src/stores/**/*"
  - "src/components/**/*"
alwaysApply: true
---

# å¼€å‘è§„èŒƒ

## 1. Server Actions ä¼˜å…ˆåŸåˆ™

**æ‰€æœ‰æ•°æ®æ“ä½œå¿…é¡»é€šè¿‡ Server Actions å®ç°ï¼Œç¦æ­¢ä½¿ç”¨ä¼ ç»Ÿ API Routes**

```typescript
// âœ… æ­£ç¡®: ä½¿ç”¨ Server Action
// app/actions/cluster.ts
'use server'

export async function mergeClusters(clusterIds: string[]) {
  return await db.update(clusters)...
}

// âŒ é”™è¯¯: ä½¿ç”¨ API Route
// app/api/clusters/merge/route.ts
export async function POST(req: Request) { ... }
```

## 2. Hooks è°ƒç”¨è§„èŒƒ

**å®¢æˆ·ç«¯ç»„ä»¶å¿…é¡»é€šè¿‡ React Query Hooks è°ƒç”¨ Server Actions**

| æ“ä½œç±»å‹ | å¿…é¡»ä½¿ç”¨ | ç¦æ­¢ä½¿ç”¨ |
|---------|---------|---------|
| æŸ¥è¯¢ (GET) | `useQuery` | è‡ªå®šä¹‰ fetch |
| åˆ›å»º (CREATE) | `useMutation` | è‡ªå®šä¹‰ async å‡½æ•° |
| æ›´æ–° (UPDATE) | `useMutation` | è‡ªå®šä¹‰ async å‡½æ•° |
| åˆ é™¤ (DELETE) | `useMutation` | è‡ªå®šä¹‰ async å‡½æ•° |

## 3. Server Action å®šä¹‰ç¤ºä¾‹

```typescript
// app/actions/identity.ts
'use server'

import { db } from '@/db'
import { identities } from '@/db/schema'
import { revalidatePath } from 'next/cache'

// æŸ¥è¯¢æ“ä½œ - ä¾› useQuery ä½¿ç”¨
export async function getIdentities() {
  return await db.select().from(identities)
}

export async function getIdentityById(id: string) {
  return await db.query.identities.findFirst({
    where: eq(identities.id, id)
  })
}

// å˜æ›´æ“ä½œ - ä¾› useMutation ä½¿ç”¨
export async function createIdentity(data: CreateIdentityInput) {
  const result = await db.insert(identities).values(data).returning()
  revalidatePath('/identities')
  return result[0]
}

export async function updateIdentity(id: string, data: UpdateIdentityInput) {
  const result = await db.update(identities)
    .set(data)
    .where(eq(identities.id, id))
    .returning()
  revalidatePath('/identities')
  return result[0]
}

export async function deleteIdentity(id: string) {
  await db.delete(identities).where(eq(identities.id, id))
  revalidatePath('/identities')
}
```

## 4. React Query Hooks ç¤ºä¾‹

```typescript
// hooks/use-identities.ts
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query'
import { 
  getIdentities, 
  getIdentityById,
  createIdentity, 
  updateIdentity, 
  deleteIdentity 
} from '@/app/actions/identity'

// âœ… æŸ¥è¯¢ Hook - useQuery
export function useIdentities() {
  return useQuery({
    queryKey: ['identities'],
    queryFn: () => getIdentities(),
  })
}

export function useIdentity(id: string) {
  return useQuery({
    queryKey: ['identities', id],
    queryFn: () => getIdentityById(id),
    enabled: !!id,
  })
}

// âœ… å˜æ›´ Hook - useMutation
export function useCreateIdentity() {
  const queryClient = useQueryClient()
  
  return useMutation({
    mutationFn: createIdentity,
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['identities'] })
    },
  })
}

export function useUpdateIdentity() {
  const queryClient = useQueryClient()
  
  return useMutation({
    mutationFn: ({ id, data }: { id: string; data: UpdateIdentityInput }) => 
      updateIdentity(id, data),
    onSuccess: (_, { id }) => {
      queryClient.invalidateQueries({ queryKey: ['identities'] })
      queryClient.invalidateQueries({ queryKey: ['identities', id] })
    },
  })
}

export function useDeleteIdentity() {
  const queryClient = useQueryClient()
  
  return useMutation({
    mutationFn: deleteIdentity,
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['identities'] })
    },
  })
}
```

## 5. çŠ¶æ€ç®¡ç†åˆ’åˆ†

| çŠ¶æ€ç±»å‹ | ç®¡ç†æ–¹æ¡ˆ | è¯´æ˜ |
|---------|---------|------|
| æœåŠ¡ç«¯æ•°æ® | React Query | äººè„¸ã€èšç±»ã€èº«ä»½ç­‰ä¸šåŠ¡æ•°æ® |
| å®¢æˆ·ç«¯ UI çŠ¶æ€ | Zustand | å¼¹çª—ã€é€‰ä¸­é¡¹ã€æ‹–æ‹½çŠ¶æ€ç­‰ |
| æ‘„åƒå¤´çŠ¶æ€ | Zustand | å½“å‰å¸§ã€æ£€æµ‹ç»“æœ |
| URL çŠ¶æ€ | nuqs / searchParams | ç­›é€‰ã€åˆ†é¡µã€æ’åº |

## 6. Zustand Store ç¤ºä¾‹

```typescript
// stores/camera-store.ts
interface CameraStore {
  isStreaming: boolean
  currentFrame: ImageData | null
  detectedFaces: DetectedFace[]
  selectedCameraId: string | null
  
  // Actions
  setStreaming: (value: boolean) => void
  updateFrame: (frame: ImageData) => void
  updateDetections: (faces: DetectedFace[]) => void
}
```

## 7. å®¢æˆ·ç«¯ç»„ä»¶ä½¿ç”¨ç¤ºä¾‹

```typescript
// components/identity-form.tsx
'use client'

import { useCreateIdentity, useUpdateIdentity } from '@/hooks/use-identities'

export function IdentityForm({ identity }: Props) {
  const createMutation = useCreateIdentity()
  const updateMutation = useUpdateIdentity()

  const handleSubmit = (data: FormData) => {
    if (identity) {
      updateMutation.mutate({ id: identity.id, data })
    } else {
      createMutation.mutate(data)
    }
  }

  const isPending = createMutation.isPending || updateMutation.isPending

  return (
    <form onSubmit={handleSubmit}>
      {/* è¡¨å•å†…å®¹ */}
      <Button disabled={isPending}>
        {isPending ? 'ä¿å­˜ä¸­...' : 'ä¿å­˜'}
      </Button>
    </form>
  )
}
```

---

## 8. å¯¹è¯ç»“æŸè¯­

æ¯æ¬¡å¯¹è¯å®Œæˆåï¼Œå¿…é¡»åœ¨å›å¤æœ«å°¾è¾“å‡ºï¼š

**æ­å–œå‘è´¢ ğŸ§§**
